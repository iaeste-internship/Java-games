<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>Koç</title>
    <link href="main.css" rel="stylesheet">
    <link href="css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cjrtnc.leaningtech.com/4.2/loader.js"></script>
    <style>
        .game-stage{position:relative; width:100%; max-width:1100px; margin:1rem 0; background:#000; border-radius:12px; overflow:hidden; aspect-ratio:16/9;}
        .game-loading{position:absolute; inset:0; display:grid; place-items:center; font:600 1rem system-ui; color:#fff; letter-spacing:.3px;}
        .game-controls{position:absolute; top:.5rem; right:.5rem; display:flex; gap:.5rem; z-index:3}
        .game-controls button{background:rgba(255,255,255,.1); backdrop-filter:saturate(140%) blur(4px); color:#fff; border:1px solid rgba(255,255,255,.2); padding:.35rem .6rem; border-radius:.6rem; cursor:pointer}
        .game-controls button:hover{background:rgba(255,255,255,.2)}
        .paused-overlay{position:absolute; inset:0; background:rgba(0,0,0,.45); color:#fff; display:none; align-items:center; justify-content:center; font:600 1.1rem system-ui; z-index:2}
        .paused-overlay.show{display:flex}
        .debug-panel{background:#111; color:#cfcfcf; border:1px solid #333; border-radius:8px; padding:10px; font:12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;}
        .debug-panel .row{margin:.25rem 0}
        .debug-panel code{color:#7dd3fc}
        .debug-toggle{margin-top:8px}
    </style>

    <script>
        // ===== Preloading scaffold =====
        const PRELOAD_RESOURCES = null;
        let cjReady = false;
        async function initCheerpJWithPreload() {
            if (cjReady) return;
            const loadingEl = document.querySelector('.game-loading');
            await cheerpjInit({
                status: "default",
                preloadResources: PRELOAD_RESOURCES || undefined,
                preloadProgress: (done, total) => {
                    if (!loadingEl) return;
                    const pct = total ? Math.floor((done * 100) / total) : 0;
                    loadingEl.textContent = `Loading… ${pct}%`;
                }
            });
            cjReady = true;
            if (!PRELOAD_RESOURCES && typeof cjGetRuntimeResources === "function") {
                cjGetRuntimeResources().then(obj => {
                    console.log("%cCopy this into PRELOAD_RESOURCES:", "font-weight:bold");
                    console.log(JSON.stringify(obj, null, 2));
                }).catch(()=>{});
            }
        }

        // ===== Path resolver with detailed diagnostics =====
        function logDebug(msg) {
            const pre = document.getElementById('debug-log');
            if (pre) pre.textContent += msg + "\n";
            console.log(msg);
        }

        async function probeUrl(url) {
            try {
                const head = await fetch(url, { method: 'HEAD', cache: 'no-store' });
                const ok = head.ok;
                const status = head.status;
                const len = head.headers.get('content-length');
                // Range test (GET 0-0)
                let rangeOk = false, rangeStatus = null;
                try {
                    const r = await fetch(url, { method: 'GET', headers: { 'Range': 'bytes=0-0' }, cache: 'no-store' });
                    rangeStatus = r.status;
                    rangeOk = r.status === 206;
                } catch (e) {}
                return { ok, status, len, rangeOk, rangeStatus };
            } catch (e) {
                return { ok:false, status:0, len:null, rangeOk:false, rangeStatus:null, error: String(e) };
            }
        }

        async function resolveCheerpJJarDetailed(appRelativePath) {
            const repoBase = window.location.pathname.replace(/[^/]*$/, ''); // "/", or "/repo/"
            const realCandidates = [
                repoBase + appRelativePath, // "/repo/JAR/UNO.jar" or "/JAR/UNO.jar"
                '/' + appRelativePath.replace(/^\//,'') // "/JAR/UNO.jar"
            ];
            for (const realUrl of realCandidates) {
                logDebug('Probing ' + realUrl + ' ...');
                const res = await probeUrl(realUrl);
                logDebug('  status=' + res.status + ' content-length=' + (res.len||'?') + ' range=' + res.rangeStatus + (res.rangeOk?' (OK)':' (NOT 206)'));
                if (res.ok) {
                    // Return CheerpJ path (with /app prefix)
                    const appPath = '/app' + realUrl;
                    return { appPath, realUrl, diag: res };
                }
            }
            throw new Error('UNO.jar not reachable at: ' + realCandidates.join(' , '));
        }

        // ===== UNO launcher =====
        async function runUno(e) {
            if (e) e.preventDefault();
            const btn = document.getElementById('play-uno');

            // Create the container if it doesn't exist
            let stage = document.getElementById('uno-stage');
            if (!stage) {
                stage = document.createElement('div');
                stage.id = 'uno-stage';
                stage.className = 'game-stage';

                const controls = document.createElement('div');
                controls.className = 'game-controls';
                controls.innerHTML = `
          <button id="btn-full" type="button">Fullscreen</button>
          <button id="btn-restart" type="button">Restart</button>
          <button id="btn-debug" type="button">Show debug</button>
        `;
                const loading = document.createElement('div');
                loading.className = 'game-loading';
                loading.textContent = 'Loading…';
                const paused = document.createElement('div');
                paused.className = 'paused-overlay';
                paused.textContent = 'Game paused';

                stage.append(controls, loading, paused);
                (btn.parentElement || document.body).insertBefore(stage, btn.nextSibling);

                controls.querySelector('#btn-full').addEventListener('click', async () => {
                    const el = stage;
                    if (!document.fullscreenElement) await el.requestFullscreen?.();
                    else await document.exitFullscreen?.();
                });
                controls.querySelector('#btn-restart').addEventListener('click', () => location.reload());
                controls.querySelector('#btn-debug').addEventListener('click', () => {
                    document.getElementById('debug-wrap').classList.toggle('d-none');
                });
                document.addEventListener('visibilitychange', () => {
                    paused.classList.toggle('show', document.hidden);
                });
            }

            const icon = btn.querySelector('.play-icon');
            const prevIcon = icon ? icon.textContent : null;
            btn.style.pointerEvents = 'none';
            btn.setAttribute('aria-busy', 'true');
            if (icon) icon.textContent = '⏳';

            try {
                await initCheerpJWithPreload();

                const { appPath, realUrl } = await resolveCheerpJJarDetailed('JAR/UNO.jar');
                logDebug('Using CheerpJ path: ' + appPath);

                const display = cheerpjCreateDisplay(-1, -1, stage);
                display.style.width = '100%';
                display.style.height = '100%';

                const exit = await cheerpjRunJar(appPath);
                console.log('UNO.jar finished with code', exit);
                stage.querySelector('.game-loading')?.remove();
            } catch (err) {
                logDebug('ERROR: ' + err.message);
                alert('Failed to start UNO.jar. See debug panel / Console.');
            } finally {
                btn.style.pointerEvents = '';
                btn.removeAttribute('aria-busy');
                if (icon) icon.textContent = prevIcon || '▶';
            }
        }

        window.addEventListener('load', async () => { try { await initCheerpJWithPreload(); } catch {} });
    </script>
</head>

<body>
<div class="header">
    <div class="branding d-flex align-items-center">
        <div class="container position-relative d-flex align-items-left">
            <a href="index.html" class="logo d-flex align-items-left me-3">
                <img src="img/cropped-logo.png" alt="Logo">
            </a>
            <nav id="navmenu" class="navmenu flex-grow-1 text-center">
                <ul class="d-inline-flex list-unstyled mb-0">
                    <li><a href="index.html#research" data-i18n="research"></a></li>
                    <li><a href="index.html#games" data-i18n="games"></a></li>
                    <li><a href="https://www.ku.edu.tr/" data-i18n="home"></a></li>
                </ul>
                <i class="mobile-nav-toggle d-xl-none bi bi-list"></i>
            </nav>
            <div id="lang-switcher">
                <button class="lang-btn" data-lang="es">ES</button>
                <span class="separator">|</span>
                <button class="lang-btn" data-lang="en">EN</button>
                <span class="separator">|</span>
                <button class="lang-btn active" data-lang="tr">TR</button>
            </div>
        </div>
    </div>
</div>

<main class="main">
    <section id="description" class="description">
        <h2>UNO:</h2>
        <button id="play-uno" onclick="runUno(event)" class="button">
            <img src="img/uno.png" alt="">
            <span class="play-icon" data-i18n="play">▶</span>
        </button>
        <div class="description-box">
            <h3 data-i18n="gameDescriptionUno"></h3>
        </div>
        <div id="debug-wrap" class="debug-panel d-none">
            <div class="row"><strong>Debug log</strong></div>
            <pre id="debug-log"></pre>
        </div>
    </section>
</main>

<script src="main.js"></script>
<script>
    if (localStorage.getItem('loggedIn') !== 'true') {
        const current = window.location.pathname.split('/').pop().replace('.html','');
        window.location.replace('login.html?target=' + current);
    }
</script>
</body>
</html>
